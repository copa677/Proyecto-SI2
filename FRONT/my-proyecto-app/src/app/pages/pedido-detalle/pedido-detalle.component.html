<section class="py-6 px-4 sm:px-6 lg:px-8">
  <div class="max-w-7xl mx-auto">

    <!-- Botón para volver a la lista de pedidos -->
    <button type="button"
      class="inline-flex items-center text-sm text-gray-500 hover:text-gray-700 mb-4"
      (click)="volver()">
      <i class="fas fa-arrow-left mr-2"></i> Volver a la lista de pedidos
    </button>
    

    
    <!-- Encabezado -->
    <div class="mb-6">
      <h2 class="text-2xl font-bold text-gray-900" *ngIf="pedido">
        Detalle del Pedido: {{ pedido.cod_pedido }}
      </h2>
      <h2 class="text-2xl font-bold text-gray-900" *ngIf="!pedido">
        Detalle del Pedido
      </h2>
      <p class="mt-1 text-sm text-gray-600">Visualiza y gestiona los productos de este pedido</p>
    </div>

    <!-- Información del Pedido -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-6" *ngIf="pedido">
      <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">Información del Pedido</h3>
      </div>
      <div class="px-4 py-5 sm:p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <p class="text-sm font-medium text-gray-500">Código</p>
            <p class="mt-1 text-sm text-gray-900">{{ pedido.cod_pedido }}</p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Cliente</p>
            <p class="mt-1 text-sm text-gray-900">#{{ pedido.id_cliente }}</p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Fecha Pedido</p>
            <p class="mt-1 text-sm text-gray-900">{{ pedido.fecha_pedido | date:'dd/MM/yyyy' }}</p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Fecha Entrega</p>
            <p class="mt-1 text-sm text-gray-900">{{ pedido.fecha_entrega_prometida | date:'dd/MM/yyyy' }}</p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Estado</p>
            <p class="mt-1">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" [ngClass]="getEstadoBadgeClass(pedido.estado)">
                {{ getEstadoLabel(pedido.estado) }}
              </span>
            </p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Total</p>
            <p class="mt-1 text-lg font-bold text-green-600">Bs {{ pedido.total }}</p>
          </div>
          <div class="md:col-span-3">
            <p class="text-sm font-medium text-gray-500">Observaciones</p>
            <p class="mt-1 text-sm text-gray-900">{{ pedido.observaciones || 'Sin observaciones' }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Productos del Pedido -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
      <div class="px-4 py-5 sm:px-6 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg font-medium text-gray-900">Productos del Pedido</h3>
        <button 
          class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700" 
          (click)="abrirFormulario()">
          <i class="fas fa-plus mr-2"></i> Agregar Producto
        </button>
      </div>
      <div class="px-4 py-5 sm:p-6">
        
        <!-- Tabla de Productos -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cuello</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Manga</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Color</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Talla</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unit.</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr *ngIf="detalles.length === 0">
                <td colspan="10" class="px-6 py-8 text-center text-gray-500">
                  No hay productos en este pedido. Agregue productos usando el botón "Agregar Producto"
                </td>
              </tr>
              <tr *ngFor="let detalle of detalles" class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-800">
                    {{ detalle.tipo_prenda }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ detalle.cuello }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ detalle.manga }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ detalle.color }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ detalle.talla }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ detalle.material }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">{{ detalle.cantidad }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Bs {{ detalle.precio_unitario }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">Bs {{ detalle.subtotal }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <button 
                    class="text-yellow-600 hover:text-yellow-900 mr-3" 
                    (click)="editarDetalle(detalle)" 
                    title="Editar">
                    <i class="fas fa-edit mr-1"></i> Editar
                  </button>
                  <button 
                    class="text-red-600 hover:text-red-900" 
                    (click)="eliminarDetalle(detalle)" 
                    title="Eliminar">
                    <i class="fas fa-trash mr-1"></i> Eliminar
                  </button>
                </td>
              </tr>
            </tbody>
            <tfoot *ngIf="detalles.length > 0" class="bg-gray-50">
              <tr>
                <td colspan="8" class="px-6 py-4 text-right text-sm font-medium text-gray-900">
                  TOTAL DEL PEDIDO:
                </td>
                <td colspan="2" class="px-6 py-4 text-sm">
                  <span class="text-lg font-bold text-green-600">Bs {{ pedido?.total }}</span>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Modal para Agregar/Editar Producto -->
    <div *ngIf="mostrarFormulario" class="fixed inset-0 z-50 flex items-center justify-center overflow-y-auto px-4 py-6 sm:px-0" (keydown.escape)="cancelarEdicion()" tabindex="0">
      <!-- Backdrop -->
      <div class="absolute inset-0 bg-gray-900/50 transition-opacity" (click)="cancelarEdicion()"></div>

      <!-- Contenedor del modal -->
      <div class="relative bg-white rounded-lg shadow-2xl w-full max-w-4xl mx-auto flex flex-col max-h-[90vh] overflow-hidden transform transition-all sm:my-8">
        
        <!-- Header del Modal -->
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 bg-gray-50">
          <h3 class="text-lg font-semibold text-gray-900">
            {{ modoEdicion ? 'Editar Producto' : 'Nuevo Producto' }}
          </h3>
          <button class="text-gray-400 hover:text-gray-600 focus:outline-none" (click)="cancelarEdicion()" aria-label="Cerrar">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- Body del Modal (con scroll) -->
        <div class="flex-1 overflow-y-auto px-4 py-5 sm:p-6">
          <form [formGroup]="detalleForm" (ngSubmit)="agregarDetalle()">
            
            <!-- Autocompletado de Producto -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-search mr-2 text-indigo-600"></i>Buscar Producto
              </label>
              <div class="relative">
                <input 
                  type="text" 
                  class="form-input block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" 
                  placeholder="Buscar por descripción, material o talla..."
                  [(ngModel)]="busquedaProducto" 
                  [ngModelOptions]="{standalone: true}"
                  (input)="filtrarProductos($event)" 
                  (focus)="filtrarProductos($event)"
                  (blur)="ocultarAutocompleteProducto()" 
                  autocomplete="off">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-search text-gray-400"></i>
                </div>
                
                <!-- Lista desplegable de productos -->
                <div *ngIf="mostrarAutocompleteProducto && productosFiltrados.length > 0" 
                     class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto">
                  <ul class="divide-y divide-gray-100">
                    <li *ngFor="let producto of productosFiltrados" 
                        (mousedown)="seleccionarProducto(producto)"
                        class="px-4 py-3 cursor-pointer hover:bg-indigo-50 transition-colors">
                      <div class="flex justify-between items-center">
                        <div class="flex-1">
                          <p class="font-semibold text-gray-900">{{ producto.decripcion }}</p>
                          <p class="text-sm text-gray-500">
                            <span class="inline-flex items-center">
                              <i class="fas fa-cube mr-1"></i>{{ producto.material }}
                            </span>
                            <span class="mx-2">•</span>
                            <span class="inline-flex items-center">
                              <i class="fas fa-ruler mr-1"></i>Talla: {{ producto.talla }}
                            </span>
                          </p>
                        </div>
                        <div class="text-right ml-4">
                          <p class="text-lg font-bold text-green-600">Bs {{ producto.precio_base }}</p>
                          <p class="text-xs text-gray-500">Precio base</p>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
                
                <!-- Mensaje cuando no hay resultados -->
                <div *ngIf="mostrarAutocompleteProducto && productosFiltrados.length === 0 && busquedaProducto.length > 0" 
                     class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg p-4">
                  <p class="text-sm text-gray-500 text-center">
                    <i class="fas fa-info-circle mr-2"></i>No se encontraron productos
                  </p>
                </div>
              </div>
              <p class="mt-2 text-xs text-gray-500">
                <i class="fas fa-lightbulb mr-1 text-yellow-500"></i>
                Selecciona un producto para auto-completar material y talla
              </p>
            </div>

            <!-- Separador -->
            <div class="border-t border-gray-200 my-4"></div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              
              <div>
                <label class="block text-sm font-medium text-gray-700">Tipo de Prenda <span class="text-red-500">*</span></label>
                <select class="form-input mt-1 block w-full" formControlName="tipo_prenda" (change)="onTipoPrendaChange()">
                  <option *ngFor="let tipo of tiposPrenda" [value]="tipo.value">{{ tipo.label }}</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700">Cuello <span class="text-red-500">*</span></label>
                <select class="form-input mt-1 block w-full" formControlName="cuello">
                  <option value="">Seleccione</option>
                  <option *ngFor="let cuello of cuelloOptions" [value]="cuello">{{ cuello }}</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Manga <span class="text-red-500">*</span></label>
                <select class="form-input mt-1 block w-full" formControlName="manga">
                  <option value="">Seleccione</option>
                  <option *ngFor="let manga of mangaOptions" [value]="manga">{{ manga }}</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Material <span class="text-red-500">*</span></label>
                <select class="form-input mt-1 block w-full" formControlName="material">
                  <option value="">Seleccione</option>
                  <option *ngFor="let material of materiales" [value]="material">{{ material }}</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Color <span class="text-red-500">*</span></label>
                <input type="text" class="form-input mt-1 block w-full" formControlName="color" placeholder="Ej: Azul marino">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Talla <span class="text-red-500">*</span></label>
                <select class="form-input mt-1 block w-full" formControlName="talla">
                  <option value="">Seleccione</option>
                  <option *ngFor="let talla of tallas" [value]="talla">{{ talla }}</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Cantidad <span class="text-red-500">*</span></label>
                <input type="number" class="form-input mt-1 block w-full" formControlName="cantidad" min="1">
              </div>

              <div class="md:col-span-1">
                <label class="block text-sm font-medium text-gray-700">Precio Sugerido</label>
                <div class="flex space-x-2 mt-1">
                  <div class="flex-grow relative rounded-md shadow-sm">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                      <span class="text-gray-500 sm:text-sm">$</span>
                    </div>
                    <input type="text" class="form-input block w-full pl-7 bg-gray-100" [value]="precioSugerido || 'N/A'" readonly>
                  </div>
                  <!-- Botón de buscar precio eliminado, el precio se autocompleta -->
                </div>
                <p class="mt-1 text-xs text-gray-500">Precio unitario calculado</p>
              </div>
            </div>
          </form>
        </div>

        <!-- Footer del Modal -->
        <div class="px-4 py-3 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
          <button 
            type="button" 
            class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" 
            (click)="cancelarEdicion()"
            [disabled]="guardando">
            <i class="fas fa-times mr-2"></i> Cancelar
          </button>
          <button 
            type="submit" 
            class="inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700" 
            (click)="agregarDetalle()"
            [disabled]="detalleForm.invalid || guardando">
            <i *ngIf="guardando" class="fas fa-spinner fa-spin mr-2"></i>
            <i *ngIf="!guardando" class="fas fa-save mr-2"></i>
            {{ modoEdicion ? 'Actualizar Producto' : 'Agregar Producto' }}
          </button>
        </div>

      </div>
    </div>

  </div>
</section>
